<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•ç®€å•èŠå¤©è½¬å‘</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-item {
            margin-bottom: 20px;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .success {
            background-color: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #e7f3ff;
            border-color: #b3d9ff;
            color: #0c5460;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .secondary {
            background-color: #008CBA;
        }
        .secondary:hover {
            background-color: #007B9A;
        }
        textarea {
            width: 100%;
            height: 100px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            resize: vertical;
        }
        .response-area {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            min-height: 100px;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤– æµ‹è¯•ç®€å•èŠå¤©è½¬å‘</h1>
        
        <div class="info test-item">
            <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong><br>
            ç›´æ¥æµ‹è¯•OpenAIèŠå¤©APIçš„è½¬å‘åŠŸèƒ½ï¼Œé¿å¼€agentsç›¸å…³çš„å¤æ‚é€»è¾‘ï¼Œç¡®ä¿èƒ½çœ‹åˆ°è½¬å‘æ—¥å¿—ã€‚
        </div>

        <div id="results"></div>

        <div style="margin-top: 20px;">
            <h3>ğŸ“ å‘é€æµ‹è¯•æ¶ˆæ¯ï¼š</h3>
            <textarea id="messageInput" placeholder="è¾“å…¥è¦å‘é€ç»™AIçš„æ¶ˆæ¯...">Hello, this is a test message to verify the forwarding logs. Please respond with a simple greeting.</textarea>
            <br><br>
            <button onclick="setupUserAndLogin()">1. è®¾ç½®ç”¨æˆ·å¹¶ç™»å½•</button>
            <button onclick="sendDirectMessage()" class="secondary">2. å‘é€æµ‹è¯•æ¶ˆæ¯</button>
            <button onclick="checkLogs()" class="secondary">3. æ£€æŸ¥æ—¥å¿—è¯´æ˜</button>
        </div>

        <div id="responseArea" class="response-area" style="display: none;">
            <strong>AIå“åº”ï¼š</strong><br>
            <div id="responseContent"></div>
        </div>

        <div style="margin-top: 20px;">
            <h3>ğŸ” é¢„æœŸçš„è½¬å‘æ—¥å¿—ï¼š</h3>
            <div class="info">
                åœ¨æœåŠ¡å™¨æ—¥å¿—ä¸­ï¼Œä½ åº”è¯¥çœ‹åˆ°ä»¥ä¸‹ç±»å‹çš„æ—¥å¿—ï¼š<br><br>
                <code>ğŸš€ [OpenAIè½¬å‘é…ç½®] åˆå§‹åŒ–å®¢æˆ·ç«¯</code><br>
                <code>ğŸŒ [OpenAIè¯·æ±‚è½¬å‘] å‡†å¤‡å‘é€è¯·æ±‚</code><br>
                <code>ğŸ”§ [OpenAIå®¢æˆ·ç«¯åˆ›å»º] é…ç½®å‚æ•°</code><br>
                <code>ğŸ“¡ [OpenAIè¯·æ±‚å‘é€] å³å°†å‘é€åˆ°ä¸Šæ¸¸æœåŠ¡</code><br>
                <code>âœ… [OpenAIå“åº”æ¥æ”¶] æ”¶åˆ°ä¸Šæ¸¸æœåŠ¡å“åº”</code><br><br>
                <strong>å…³é”®éªŒè¯ç‚¹ï¼š</strong><br>
                â€¢ targetURL åº”è¯¥æ˜¯: https://api-dev.718ai.cn/v1/chat/completions<br>
                â€¢ apiKey åº”è¯¥æ˜¾ç¤º: ak_e8244e22...ï¼ˆè„±æ•ï¼‰
            </div>
        </div>

        <div style="margin-top: 20px;">
            <h3>ğŸ› ï¸ æ•…éšœæ’é™¤ï¼š</h3>
            <div class="warning">
                å¦‚æœæ²¡æœ‰çœ‹åˆ°è½¬å‘æ—¥å¿—ï¼š<br>
                1. ç¡®ä¿ DEBUG_CONSOLE=true åœ¨ .env æ–‡ä»¶ä¸­<br>
                2. é‡å¯ LibreChat æœåŠ¡<br>
                3. ç¡®ä¿ä½¿ç”¨çš„æ˜¯ OpenAI ç«¯ç‚¹ï¼Œè€Œä¸æ˜¯ agents<br>
                4. æ£€æŸ¥æ—¥å¿—çº§åˆ«æ˜¯å¦è®¾ç½®ä¸º info æˆ– debug
            </div>
        </div>
    </div>

    <script>
        function addResult(title, message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultItem = document.createElement('div');
            resultItem.className = `test-item ${type}`;
            resultItem.innerHTML = `<strong>${title}</strong><br>${message}`;
            resultsDiv.appendChild(resultItem);
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        function setupUserAndLogin() {
            clearResults();
            addResult('è®¾ç½®ç”¨æˆ·', 'æ­£åœ¨è®¾ç½®æµ‹è¯•ç”¨æˆ·ä¿¡æ¯...', 'info');
            
            // è®¾ç½®æµ‹è¯•ç”¨æˆ·ä¿¡æ¯
            const userData = {
                email: "chat-test@company.com",
                name: "èŠå¤©æµ‹è¯•ç”¨æˆ·",
                username: "chattest",
                role: "USER"
            };
            
            localStorage.setItem('external_user_data', JSON.stringify(userData));
            addResult('ç”¨æˆ·è®¾ç½®å®Œæˆ', 'âœ… æµ‹è¯•ç”¨æˆ·ä¿¡æ¯å·²è®¾ç½®', 'success');
            addResult('ä¸‹ä¸€æ­¥', 'å³å°†è·³è½¬åˆ°LibreChatï¼Œç™»å½•åè¯·å›åˆ°æ­¤é¡µé¢è¿›è¡Œæ­¥éª¤2', 'warning');
            
            setTimeout(() => {
                window.open('http://localhost:3080', '_blank');
            }, 2000);
        }

        async function sendDirectMessage() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                addResult('é”™è¯¯', 'è¯·è¾“å…¥è¦å‘é€çš„æ¶ˆæ¯', 'error');
                return;
            }

            clearResults();
            addResult('å‘é€æ¶ˆæ¯', 'æ­£åœ¨å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°OpenAIç«¯ç‚¹...', 'info');
            addResult('æ—¥å¿—æç¤º', 'è¯·åŒæ—¶æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œå¯»æ‰¾å¸¦æœ‰emojiçš„è½¬å‘æ—¥å¿—', 'warning');

            try {
                const response = await fetch('/api/ask/openAI', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        text: message,
                        parentMessageId: "test-" + Date.now(),
                        conversationId: null,
                        model: "gpt-3.5-turbo",
                        endpoint: "openAI",
                        endpointType: "openAI"
                    }),
                });

                if (response.ok) {
                    addResult('è¯·æ±‚æˆåŠŸ', 'âœ… æ¶ˆæ¯å·²å‘é€åˆ°OpenAIç«¯ç‚¹', 'success');
                    addResult('æ£€æŸ¥æ—¥å¿—', 'ç°åœ¨è¯·æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—ï¼Œåº”è¯¥èƒ½çœ‹åˆ°è¯¦ç»†çš„è½¬å‘æ—¥å¿—', 'info');
                    
                    // å°è¯•è¯»å–å“åº”
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    let responseText = '';
                    
                    document.getElementById('responseArea').style.display = 'block';
                    const responseContent = document.getElementById('responseContent');
                    
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) break;
                        
                        const chunk = decoder.decode(value);
                        responseText += chunk;
                        responseContent.textContent = responseText;
                    }
                    
                } else if (response.status === 401) {
                    addResult('è®¤è¯é”™è¯¯', 'âŒ éœ€è¦å…ˆç™»å½•ï¼Œè¯·ä½¿ç”¨æ­¥éª¤1ç™»å½•', 'error');
                } else {
                    addResult('è¯·æ±‚å¤±è´¥', `âŒ è¯·æ±‚å¤±è´¥ (çŠ¶æ€: ${response.status})`, 'error');
                }
            } catch (error) {
                addResult('ç½‘ç»œé”™è¯¯', `âŒ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
            }
        }

        function checkLogs() {
            clearResults();
            addResult('æ—¥å¿—æ£€æŸ¥æŒ‡å—', 'è¯·æŒ‰ä»¥ä¸‹æ–¹å¼æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š', 'info');
            
            addResult('Dockeréƒ¨ç½²', 'docker logs -f librechat | grep -E "(è½¬å‘|OpenAI|Anthropic)"', 'info');
            addResult('PM2éƒ¨ç½²', 'pm2 logs librechat | grep -E "(è½¬å‘|OpenAI|Anthropic)"', 'info');
            addResult('å¼€å‘æ¨¡å¼', 'æŸ¥çœ‹ npm run dev æ§åˆ¶å°è¾“å‡ºä¸­çš„è½¬å‘æ—¥å¿—', 'info');
            
            addResult('æ—¥å¿—è¿‡æ»¤', 'å¯»æ‰¾åŒ…å«ä»¥ä¸‹å…³é”®è¯çš„æ—¥å¿—è¡Œï¼š', 'warning');
            addResult('å…³é”®è¯', 'ğŸš€ ğŸ“¡ ğŸŒ ğŸ”§ âœ… âŒ [OpenAIè½¬å‘] [è¯·æ±‚å‘é€] [å“åº”æ¥æ”¶]', 'info');
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºè¯´æ˜
        window.onload = function() {
            addResult('å¼€å§‹æµ‹è¯•', 'æŒ‰é¡ºåºæ‰§è¡Œæ­¥éª¤ï¼š1â†’2â†’3ï¼Œç„¶åæ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—', 'info');
        };
    </script>
</body>
</html>
